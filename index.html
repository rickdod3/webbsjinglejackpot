<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#061b14" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Jingle Jackpot" />

  <title>Webb‚Äôs Jingle Jackpot</title>

  <style>
    :root{
      --bg1:#061b14;
      --bg2:#0a2b20;
      --gold:#f6d36f;
      --text:#f3fbf7;
      --muted:rgba(243,251,247,.78);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --accentR: rgba(210,43,43,.95);
      --accentG: rgba(43,210,107,.95);
      --accentY: rgba(246,211,111,1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 15%, rgba(246,211,111,.10), transparent 55%),
        radial-gradient(1200px 800px at 85% 30%, rgba(210,43,43,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Snow background */
    .snow{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;}
    .flake{
      position:absolute; top:-10vh;
      border-radius:50%;
      background:rgba(255,255,255,.9);
      opacity:.85;
      animation: fall linear infinite;
      filter: blur(.2px);
    }
    @keyframes fall{
      to { transform: translateY(120vh) translateX(var(--drift)); opacity:.2; }
    }

    /* Confetti canvas (mobile-safe) */
    #confettiCanvas{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      pointer-events:none;
      z-index:70;
    }

    /* Bonus flash layer */
    .bonusFlash{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:90;
      display:none;
      mix-blend-mode: screen;
      opacity:.95;
      background:
        radial-gradient(circle at 20% 30%, rgba(210,43,43,.95), transparent 40%),
        radial-gradient(circle at 80% 30%, rgba(43,210,107,.90), transparent 42%),
        radial-gradient(circle at 50% 75%, rgba(246,211,111,.95), transparent 48%),
        repeating-linear-gradient(45deg,
          rgba(255,255,255,.00) 0 8px,
          rgba(255,255,255,.20) 8px 14px
        );
    }
    body.bonusMode .bonusFlash{
      display:block;
      animation: megaFlash 90ms steps(1,end) infinite;
    }
    @keyframes megaFlash{
      0%   { filter:hue-rotate(0deg)   saturate(1.6) brightness(1.35); opacity:.92; }
      33%  { filter:hue-rotate(120deg) saturate(1.7) brightness(1.40); opacity:.70; }
      66%  { filter:hue-rotate(250deg) saturate(1.8) brightness(1.45); opacity:.98; }
      100% { filter:hue-rotate(360deg) saturate(1.6) brightness(1.35); opacity:.78; }
    }

    /* Bonus takeover (GIANT) */
    .bonusTakeover{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:95;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 45%, rgba(246,211,111,.30), rgba(0,0,0,.55) 70%),
        conic-gradient(from 0deg, rgba(210,43,43,.35), rgba(246,211,111,.35), rgba(43,210,107,.35), rgba(210,43,43,.35));
      backdrop-filter: blur(2px);
    }
    .bonusTakeover.on{ display:flex; animation: takeoverFade var(--takeoverDur, 3600ms) ease-out forwards; }
    @keyframes takeoverFade{
      0%{ opacity:0; }
      12%{ opacity:1; }
      80%{ opacity:1; }
      100%{ opacity:0; }
    }
    .bonusCard{
      width:min(900px, 94vw);
      border-radius:30px;
      border:2px solid rgba(246,211,111,.40);
      background: linear-gradient(180deg, rgba(15,58,43,.97), rgba(10,43,32,.97));
      box-shadow: 0 30px 100px rgba(0,0,0,.65), 0 0 70px rgba(246,211,111,.28);
      text-align:center;
      padding:28px 22px;
      transform: scale(.88);
      animation: bonusSlam var(--takeoverDur, 3600ms) ease-out forwards;
      position:relative;
      overflow:hidden;
    }
    .bonusCard::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 50% 40%, rgba(246,211,111,.28), transparent 60%),
        radial-gradient(circle at 30% 50%, rgba(210,43,43,.18), transparent 65%),
        radial-gradient(circle at 70% 55%, rgba(43,210,107,.18), transparent 65%),
        repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.10) 0 2px, rgba(255,255,255,0) 2px 9px);
      filter: blur(1px);
      opacity:.85;
      animation: sparkleSpin 420ms linear infinite;
      pointer-events:none;
    }
    @keyframes sparkleSpin{ to { transform: rotate(360deg); } }
    @keyframes bonusSlam{
      0%{ transform: scale(.78) rotate(-3deg); opacity:0; }
      18%{ transform: scale(1.05) rotate(2deg); opacity:1; }
      35%{ transform: scale(1.00) rotate(0deg); opacity:1; }
      80%{ transform: scale(1.00) rotate(0deg); opacity:1; }
      100%{ transform: scale(1.00) rotate(0deg); opacity:0; }
    }
    .bonusTitle{
      position:relative;
      margin:0;
      font-size: clamp(46px, 8vw, 96px);
      font-weight:1100;
      letter-spacing:1.1px;
      line-height:1.0;
      text-shadow: 0 14px 40px rgba(0,0,0,.50);
      animation: titleShake 120ms linear infinite;
    }
    @keyframes titleShake{
      0%{ transform: translate(0,0) rotate(0deg); }
      25%{ transform: translate(1px,-1px) rotate(-0.6deg); }
      50%{ transform: translate(-1px,1px) rotate(0.6deg); }
      75%{ transform: translate(1px,1px) rotate(-0.4deg); }
      100%{ transform: translate(0,0) rotate(0deg); }
    }
    .bonusTitle .gold{
      color: var(--gold);
      text-shadow: 0 0 22px rgba(246,211,111,.40), 0 12px 34px rgba(246,211,111,.22);
    }
    .bonusSub{
      position:relative;
      margin:12px 0 0;
      color: rgba(243,251,247,.92);
      font-weight:1000;
      letter-spacing:.4px;
      font-size: 15px;
      text-transform: uppercase;
      opacity:.95;
      animation: pulse 260ms ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity:.85; }
      50%{ transform: scale(1.03); opacity:1; }
    }

    /* FINAL PRIZE (special) takeover */
    .finalTakeover{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:94;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 40%, rgba(255,255,255,.12), rgba(0,0,0,.68) 72%),
        radial-gradient(circle at 50% 55%, rgba(246,211,111,.20), transparent 65%),
        linear-gradient(180deg, rgba(6,27,20,.25), rgba(6,27,20,.75));
      backdrop-filter: blur(3px);
    }
    .finalTakeover.on{ display:flex; animation: finalFade var(--finalDur, 5200ms) ease-out forwards; }
    @keyframes finalFade{
      0%{ opacity:0; }
      12%{ opacity:1; }
      78%{ opacity:1; }
      100%{ opacity:0; }
    }
    .finalCard{
      width:min(900px, 94vw);
      border-radius:30px;
      border:2px solid rgba(246,211,111,.34);
      background: linear-gradient(180deg, rgba(15,58,43,.94), rgba(10,43,32,.96));
      box-shadow: 0 30px 120px rgba(0,0,0,.72), 0 0 100px rgba(246,211,111,.18);
      text-align:center;
      padding:28px 22px;
      position:relative;
      overflow:hidden;
      transform: translateY(10px) scale(.96);
      animation: finalFloat var(--finalDur, 5200ms) ease-out forwards;
    }
    @keyframes finalFloat{
      0%{ opacity:0; transform: translateY(16px) scale(.94); }
      18%{ opacity:1; transform: translateY(0) scale(1.01); }
      55%{ opacity:1; transform: translateY(-6px) scale(1.01); }
      100%{ opacity:0; transform: translateY(-10px) scale(1.00); }
    }
    .finalCard::before{
      content:"";
      position:absolute; inset:-60px;
      background:
        radial-gradient(circle at 50% 35%, rgba(246,211,111,.16), transparent 62%),
        radial-gradient(circle at 30% 55%, rgba(43,210,107,.10), transparent 70%),
        radial-gradient(circle at 70% 55%, rgba(210,43,43,.10), transparent 70%),
        repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.07) 0 2px, rgba(255,255,255,0) 2px 14px);
      opacity:.85;
      animation: sparkleSpinSlow 3200ms linear infinite;
      pointer-events:none;
      filter: blur(.8px);
    }
    @keyframes sparkleSpinSlow{ to { transform: rotate(360deg); } }
    .finalEmojiRow{
      position:relative;
      font-size: clamp(38px, 6.2vw, 64px);
      letter-spacing: 10px;
      margin-bottom: 8px;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.35));
    }
    .finalTitle{
      position:relative;
      margin:0;
      font-size: clamp(34px, 6.2vw, 74px);
      font-weight:1150;
      letter-spacing:.8px;
      line-height:1.05;
      text-shadow: 0 14px 45px rgba(0,0,0,.45);
    }
    .finalTitle .gold{ color:var(--gold); }
    .finalSub{
      position:relative;
      margin:12px 0 0;
      color: rgba(243,251,247,.90);
      font-weight:950;
      letter-spacing:.4px;
      font-size: 14px;
      text-transform: uppercase;
      opacity:.92;
    }

    .wrap{
      position:relative; z-index:1;
      min-height:100svh;
      display:flex; align-items:center; justify-content:center;
      padding:
        calc(18px + env(safe-area-inset-top))
        calc(14px + env(safe-area-inset-right))
        calc(24px + env(safe-area-inset-bottom))
        calc(14px + env(safe-area-inset-left));
    }

    .machine{
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:26px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      padding:22px;
      position:relative;
      overflow:hidden;
      transition: box-shadow .2s ease, border-color .2s ease, filter .2s ease;
    }

    body.bonusMode .machine{
      border-color: rgba(246,211,111,.45);
      box-shadow:
        0 18px 55px rgba(0,0,0,.55),
        0 0 0 4px rgba(246,211,111,.14),
        0 0 80px rgba(246,211,111,.24),
        0 0 130px rgba(43,210,107,.12);
      animation: machineShake 120ms linear infinite, hueCycle 600ms linear infinite;
      filter: brightness(1.10) saturate(1.25);
    }
    @keyframes machineShake{
      0%{ transform: translate(0,0) rotate(0deg); }
      25%{ transform: translate(1px,-1px) rotate(-0.25deg); }
      50%{ transform: translate(-1px,1px) rotate(0.25deg); }
      75%{ transform: translate(1px,1px) rotate(-0.20deg); }
      100%{ transform: translate(0,0) rotate(0deg); }
    }
    @keyframes hueCycle{ to{ filter: brightness(1.10) saturate(1.35) hue-rotate(360deg); } }
    body.bonusMode .machine::before{
      content:"";
      position:absolute; inset:-10px;
      border-radius:34px;
      background: conic-gradient(
        from 0deg,
        rgba(210,43,43,.65),
        rgba(246,211,111,.65),
        rgba(43,210,107,.65),
        rgba(255,255,255,.40),
        rgba(210,43,43,.65)
      );
      filter: blur(12px);
      opacity:.80;
      animation: marqueeSpin 260ms linear infinite;
      pointer-events:none;
      z-index:0;
    }
    @keyframes marqueeSpin{ to{ transform: rotate(360deg); } }
    .content{ position:relative; z-index:1; }

    .top{ display:flex; flex-direction:column; align-items:center; gap:12px; text-align:center; }
    h1{margin:0; font-size: clamp(22px, 3.0vw, 38px); letter-spacing:.2px;}
    .sub{ margin:0; color:var(--muted); font-size:14px; line-height:1.35; }

    .lights{
      display:flex; gap:10px; align-items:center; justify-content:center;
      width:100%; padding-top:2px;
    }
    .bulb{
      width:14px; height:14px; border-radius:50%;
      border:1px solid rgba(255,255,255,.15);
      animation: blink 1.1s infinite;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .bulb:nth-child(3n+1){ background: var(--accentR); animation-delay:.0s;}
    .bulb:nth-child(3n+2){ background: var(--accentY); animation-delay:.15s;}
    .bulb:nth-child(3n+3){ background: var(--accentG); animation-delay:.3s;}
    @keyframes blink{
      0%,100%{ transform: translateY(0); filter:saturate(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
      50%{ transform: translateY(-1px); filter:saturate(1.2); box-shadow: 0 0 22px rgba(246,211,111,.38); }
    }
    body.bonusMode .bulb{ animation-duration:.16s; box-shadow: 0 0 44px rgba(246,211,111,.35); }

    .panel{
      margin-top:18px;
      background: linear-gradient(180deg, rgba(15,58,43,.85), rgba(12,47,35,.85));
      border:1px solid rgba(255,255,255,.10);
      border-radius:24px;
      padding:18px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }

    .reelsRow{
      display:flex;
      gap:14px;
      justify-content:center;
      flex-wrap:wrap;
      align-items:stretch;
    }

    .reel{
      width: clamp(120px, 26vw, 180px);
      height: clamp(168px, 26vh, 198px);
      border-radius:22px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25), 0 10px 25px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      flex: 1 1 auto;
      max-width: 220px;
    }
    .reel::before, .reel::after{
      content:"";
      position:absolute; left:0; right:0;
      height:44px; z-index:2; pointer-events:none;
    }
    .reel::before{top:0; background: linear-gradient(180deg, rgba(6,27,20,.90), rgba(6,27,20,0));}
    .reel::after{bottom:0; background: linear-gradient(0deg, rgba(6,27,20,.90), rgba(6,27,20,0));}

    .payline{
      position:absolute; left:10px; right:10px; top:50%;
      transform: translateY(-50%);
      height:52px;
      border-radius:16px;
      border:2px solid rgba(246,211,111,.65);
      box-shadow: 0 0 24px rgba(246,211,111,.18);
      z-index:3;
      pointer-events:none;
    }
    body.bonusMode .payline{
      border-color: rgba(255,255,255,.55);
      box-shadow: 0 0 60px rgba(246,211,111,.35), 0 0 90px rgba(210,43,43,.18);
    }

    .reelGrid{
      position:absolute;
      inset: 14px 0 14px 0;
      display:grid;
      grid-template-rows: repeat(3, 1fr);
      gap: 10px;
      padding: 0 12px;
      z-index:1;
    }

    .cell{
      height:52px;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:44px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      user-select:none;
    }

    body.bonusMode .reel{
      animation: reelPulse 160ms ease-in-out infinite;
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.25),
        0 12px 30px rgba(0,0,0,.45),
        0 0 50px rgba(246,211,111,.20);
    }
    @keyframes reelPulse{
      0%{ transform: translateY(0) scale(1); filter: brightness(1.05) saturate(1.2); }
      50%{ transform: translateY(-1px) scale(1.01); filter: brightness(1.10) saturate(1.35); }
      100%{ transform: translateY(0) scale(1.00); filter: brightness(1.05) saturate(1.2); }
    }

    .controls{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .btn{
      border:0;
      border-radius:16px;
      padding:16px 22px;
      font-weight:1000;
      letter-spacing:.3px;
      cursor:pointer;
      color:#1a1200;
      background: linear-gradient(180deg, rgba(246,211,111,1), rgba(231,179,70,1));
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
      min-width: 240px;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn:disabled{ cursor:not-allowed; opacity:.65; filter: grayscale(.15); }
    body.bonusMode .btn{
      animation: btnThump 180ms ease-in-out infinite;
      box-shadow:
        0 14px 34px rgba(0,0,0,.55),
        0 0 0 4px rgba(246,211,111,.20),
        0 0 60px rgba(246,211,111,.30);
    }
    @keyframes btnThump{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.02); }
    }

    .toggles{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; opacity:.92; }
    .tinyBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(243,251,247,.92);
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      font-size:11px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .tinyBtn[aria-pressed="true"]{ box-shadow: 0 0 0 2px rgba(246,211,111,.14); }

    /* Popup */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
      padding:
        calc(18px + env(safe-area-inset-top))
        calc(18px + env(safe-area-inset-right))
        calc(18px + env(safe-area-inset-bottom))
        calc(18px + env(safe-area-inset-left));
    }
    .overlay.on{ display:flex; }

    .popup{
      width:min(820px, 100%);
      border-radius:28px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(15,58,43,.95), rgba(10,43,32,.95));
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      padding:26px 22px;
      text-align:center;
      position:relative;
      transform: scale(.88);
      opacity:0;
      animation: popIn 520ms ease-out forwards;
      overflow:hidden;
    }
    @keyframes popIn{
      0%{ transform: scale(.86); opacity:0; }
      60%{ transform: scale(1.02); opacity:1; }
      100%{ transform: scale(1); opacity:1; }
    }

    .popup.endLoop{
      opacity:1;
      animation: endPopupLoop 3.6s ease-in-out infinite;
    }
    @keyframes endPopupLoop{
      0%,100%{ transform: translateY(0) rotate(0deg) scale(1); }
      50%{ transform: translateY(-6px) rotate(-0.4deg) scale(1.01); }
    }

    .burst{
      position:absolute; inset:-70px -70px auto -70px;
      height:280px;
      background:
        radial-gradient(closest-side, rgba(246,211,111,.24), transparent 70%),
        radial-gradient(closest-side, rgba(43,210,107,.18), transparent 70%),
        radial-gradient(closest-side, rgba(210,43,43,.18), transparent 70%);
      filter: blur(2px);
      pointer-events:none;
    }
    .winText{
      font-weight:1100;
      letter-spacing:.6px;
      line-height:1.05;
      font-size: clamp(34px, 5.6vw, 76px);
      margin: 12px 0 8px;
      text-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    .winText .gold{
      color: var(--gold);
      text-shadow: 0 10px 34px rgba(246,211,111,.28);
    }
    .smallText{ margin: 10px 0 0; color: rgba(243,251,247,.78); font-size: 14px; }
    .closeRow{ margin-top:18px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .closeBtn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:1000;
      min-width:180px;
    }
    .closeBtn:active{ transform: translateY(1px) scale(.99); }
    .closeBtn.primary{
      background: linear-gradient(180deg, rgba(246,211,111,1), rgba(231,179,70,1));
      color:#1a1200;
      border: 1px solid rgba(246,211,111,.55);
      box-shadow:
        0 10px 26px rgba(0,0,0,.40),
        0 0 0 3px rgba(246,211,111,.14),
        0 0 46px rgba(246,211,111,.30);
    }

    @media (max-width: 520px){
      .machine{ padding:14px; border-radius:22px; }
      .panel{ padding:14px; border-radius:20px; }
      .reelsRow{ gap:10px; }
      .reel{ width:auto; flex: 1 1 30%; max-width: 150px; height: 172px; border-radius:18px; }
      .reelGrid{ inset: 12px 0 12px 0; gap:8px; padding: 0 10px; }
      .cell{ height:46px; font-size:38px; border-radius:14px; }
      .payline{ height:46px; border-radius:14px; }
      .btn{ width:100%; min-width: unset; }
      .closeBtn{ width:100%; min-width: unset; }
    }

    @media (prefers-reduced-motion: reduce){
      body.bonusMode .machine,
      .bonusTakeover.on,
      body.bonusMode .bonusFlash,
      body.bonusMode .reel,
      body.bonusMode .btn,
      .popup.endLoop,
      .finalTakeover.on{
        animation: none !important;
      }
    }
  </style>
</head>

<body>
  <canvas id="confettiCanvas"></canvas>

  <div class="bonusFlash" aria-hidden="true"></div>

  <div class="bonusTakeover" id="bonusTakeover" aria-hidden="true">
    <div class="bonusCard">
      <h2 class="bonusTitle">üéÖ <span class="gold">BONUS SPIN</span> üéÅ</h2>
      <div class="bonusSub">LIGHTS! BELLS! CHAOS! LET‚ÄôS GO!</div>
    </div>
  </div>

  <div class="finalTakeover" id="finalTakeover" aria-hidden="true">
    <div class="finalCard">
      <div class="finalEmojiRow">üéÅ üéÑ ‚≠ê</div>
      <h2 class="finalTitle"><span class="gold">GRAND FINALE</span></h2>
      <div class="finalSub">Final prize unlocked‚Ä¶</div>
    </div>
  </div>

  <div class="snow" id="snow"></div>

  <div class="wrap">
    <div class="machine">
      <div class="content" role="application" aria-label="Webb‚Äôs Jingle Jackpot slot machine">
        <div class="top">
          <div>
            <h1>üéÑ Webb‚Äôs Jingle Jackpot üé∞</h1>
            <div class="sub">Spin for your chance to win a prize!</div>
          </div>

          <div class="lights" aria-hidden="true">
            <span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span>
            <span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span>
            <span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span>
          </div>
        </div>

        <div class="panel">
          <div class="reelsRow">
            <div class="reel">
              <div class="payline" aria-hidden="true"></div>
              <div class="reelGrid">
                <div class="cell" id="r1t">üéÑ</div>
                <div class="cell" id="r1m">üéÅ</div>
                <div class="cell" id="r1b">‚ùÑÔ∏è</div>
              </div>
            </div>

            <div class="reel">
              <div class="payline" aria-hidden="true"></div>
              <div class="reelGrid">
                <div class="cell" id="r2t">üîî</div>
                <div class="cell" id="r2m">‚≠ê</div>
                <div class="cell" id="r2b">‚õÑ</div>
              </div>
            </div>

            <div class="reel">
              <div class="payline" aria-hidden="true"></div>
              <div class="reelGrid">
                <div class="cell" id="r3t">ü¶å</div>
                <div class="cell" id="r3m">üß¶</div>
                <div class="cell" id="r3b">üç™</div>
              </div>
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="spinBtn"><span>SPIN</span> üîî</button>

            <div class="toggles">
              <button class="tinyBtn" id="musicBtn" aria-pressed="true">üéµ Music</button>
              <button class="tinyBtn" id="sfxBtn" aria-pressed="true">üîä SFX</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="popup" id="popupCard">
      <div class="burst" aria-hidden="true"></div>
      <div class="winText" id="winText">YOU WON<br/><span class="gold">PRIZE NUMBER 1</span></div>
      <div class="smallText" id="smallText">Show this number to claim your prize üéÅ</div>
      <div class="closeRow">
        <button class="closeBtn" id="closeBtn">CLOSE</button>
        <button class="closeBtn primary" id="spinAgainBtn">SPIN AGAIN</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ----------------------------
  // SETTINGS
  // ----------------------------
  const BASE_WIN_CHANCE = 0.70;
  const BONUS_WIN_CHANCE = 1.00;

  // Santa trigger: guaranteed at least 3 times during a full 20-prize run
  const GUARANTEED_SANTA_TRIGGERS = 3;

  // Optional extra triggers beyond guaranteed (kept low)
  const EXTRA_SANTA_CHANCE = 0.06;      // 6% chance
  const EXTRA_SANTA_COOLDOWN_WINS = 2;  // prevent clustering

  const SANTA_SYMBOL = "üéÖ";

  // Timing
  const SANTA_MOMENTUM_DELAY_MS = 950;  // let them SEE the triple Santa
  const WIN_POPUP_DELAY_MS = 650;
  const BONUS_TEXT_DURATION_MS = 3800;

  // Finale spacing
  const FINAL_TAKEOVER_MS = 5200;
  const FINAL_TO_END_GAP_MS = 1500;

  const NORMAL = { intervalMs:60, d1:900, d2:1200, d3:1500, confettiStrength:1.0, confettiMs:1200 };
  const BONUS  = { intervalMs:18, d1:2600, d2:3000, d3:3400, confettiStrength:1.9, confettiMs:2400 };

  // IMPORTANT:
  // - Santa can appear on reels randomly while spinning, but we NEVER allow "triple Santa win".
  // - Triple Santa is ONLY forced on the Santa trigger spin.
  const symbolsAll = ["üéÑ","üéÅ","‚ùÑÔ∏è","üîî","‚≠ê","üß¶","‚õÑ","ü¶å","üç™", "üéÖ"];
  const symbolsWin = ["üéÑ","üéÅ","‚ùÑÔ∏è","üîî","‚≠ê","üß¶","‚õÑ","ü¶å","üç™"]; // NO SANTA in win-set

  const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  const reels = [
    { t: document.getElementById("r1t"), m: document.getElementById("r1m"), b: document.getElementById("r1b") },
    { t: document.getElementById("r2t"), m: document.getElementById("r2m"), b: document.getElementById("r2b") },
    { t: document.getElementById("r3t"), m: document.getElementById("r3m"), b: document.getElementById("r3b") },
  ];

  const spinBtn = document.getElementById("spinBtn");

  const overlay = document.getElementById("overlay");
  const popupCard = document.getElementById("popupCard");
  const winText = document.getElementById("winText");
  const smallText = document.getElementById("smallText");

  const closeBtn = document.getElementById("closeBtn");
  const spinAgainBtn = document.getElementById("spinAgainBtn");

  const musicBtn = document.getElementById("musicBtn");
  const sfxBtn = document.getElementById("sfxBtn");

  const bonusTakeover = document.getElementById("bonusTakeover");
  const finalTakeover = document.getElementById("finalTakeover");

  let spinning=false;
  let musicOn=true;
  let sfxOn=true;

  // popup mode: "win" | "lose" | "unlock" | "end"
  let popupMode = "win";

  // Bonus applies to NEXT spin after Santa trigger
  let bonusPending = false;

  // Prevent double-running finale
  let finaleRunning = false;

  // ---------------------------------
  // STATE (prizes + guaranteed santa milestones)
  // ---------------------------------
  const STORE_KEY="webb_jingle_jackpot_v15";

  function makeMilestones(){
    // Choose 3 unique milestones in 1..18 (so they happen before final win)
    const set = new Set();
    while(set.size < GUARANTEED_SANTA_TRIGGERS){
      set.add(1 + Math.floor(Math.random()*18)); // 1..18
    }
    return Array.from(set).sort((a,b)=>a-b);
  }

  function freshState(){
    const remaining=[];
    for(let i=1;i<=20;i++) if(i!==3) remaining.push(i);
    return {
      remaining,
      threeWon:false,
      done:false,
      spins:0,

      santaMilestones: makeMilestones(),
      santaFired: [],
      lastExtraSantaAtWon: -999,

      pendingFinale:false
    };
  }

  function loadState(){
    try{
      const raw=localStorage.getItem(STORE_KEY);
      if(!raw) return freshState();
      const s=JSON.parse(raw);
      if(!s || !Array.isArray(s.remaining)) return freshState();

      const state = {
        remaining: s.remaining.filter(n=>Number.isInteger(n)&&n>=1&&n<=20&&n!==3),
        threeWon: !!s.threeWon,
        done: !!s.done,
        spins: Number.isFinite(s.spins)?Math.max(0,Math.floor(s.spins)):0,

        santaMilestones: Array.isArray(s.santaMilestones) && s.santaMilestones.length
          ? s.santaMilestones.filter(n=>Number.isInteger(n)&&n>=1&&n<=18)
          : makeMilestones(),
        santaFired: Array.isArray(s.santaFired) ? s.santaFired.filter(n=>Number.isInteger(n)&&n>=1&&n<=18) : [],
        lastExtraSantaAtWon: Number.isFinite(s.lastExtraSantaAtWon) ? s.lastExtraSantaAtWon : -999,

        pendingFinale: !!s.pendingFinale
      };

      if(state.santaMilestones.length < GUARANTEED_SANTA_TRIGGERS){
        state.santaMilestones = makeMilestones();
        state.santaFired = [];
      }

      return state;
    }catch(e){ return freshState(); }
  }

  function saveState(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){} }
  let state=loadState();

  function prizesWonSoFarExcludingThree(){
    return 19 - state.remaining.length; // 0..19
  }

  function awardPrize(){
    if(state.done) return {type:"done"};

    if(state.remaining.length>0){
      const idx=Math.floor(Math.random()*state.remaining.length);
      const prize=state.remaining[idx];
      state.remaining.splice(idx,1);
      saveState();
      return {type:"prize", number:prize, last:false};
    }

    if(!state.threeWon){
      state.threeWon=true;
      state.done=true;
      state.pendingFinale=true; // special sequence before end popup loop
      saveState();
      return {type:"prize", number:3, last:true};
    }

    state.done=true; saveState();
    return {type:"done"};
  }

  // ---------------------------------
  // Haptics
  // ---------------------------------
  function vibrate(p){ try{ if(navigator.vibrate) navigator.vibrate(p);}catch(e){} }

  // ---------------------------------
  // Audio (WebAudio)
  // ---------------------------------
  let audioCtx=null, master=null, musicGain=null, sfxGain=null;
  let musicTimer=null, sleighTimer=null, step=0;

  function ensureAudio(){
    if(audioCtx) return;
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    master=audioCtx.createGain(); master.gain.value=0.9; master.connect(audioCtx.destination);
    musicGain=audioCtx.createGain(); musicGain.gain.value=0.10; musicGain.connect(master);
    sfxGain=audioCtx.createGain(); sfxGain.gain.value=0.40; sfxGain.connect(master);
  }
  async function resumeAudioIfNeeded(){
    ensureAudio();
    if(audioCtx.state!=="running"){ try{ await audioCtx.resume(); }catch(e){} }
  }
  function setMusic(on){
    musicOn=on; musicBtn.setAttribute("aria-pressed", String(on));
    if(!audioCtx) return;
    musicGain.gain.setTargetAtTime(on?0.10:0.0001, audioCtx.currentTime, 0.03);
  }
  function setSfx(on){
    sfxOn=on; sfxBtn.setAttribute("aria-pressed", String(on));
    if(!audioCtx) return;
    sfxGain.gain.setTargetAtTime(on?0.40:0.0001, audioCtx.currentTime, 0.02);
  }
  musicBtn.addEventListener("click", async()=>{ await resumeAudioIfNeeded(); setMusic(!musicOn); });
  sfxBtn.addEventListener("click", async()=>{ await resumeAudioIfNeeded(); setSfx(!sfxOn); });

  function bell(freq, time, dur, outGain, amp=0.22){
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    const f=audioCtx.createBiquadFilter();
    o.type="triangle"; o.frequency.setValueAtTime(freq,time);
    f.type="bandpass"; f.frequency.setValueAtTime(1400,time); f.Q.setValueAtTime(1.2,time);
    g.gain.setValueAtTime(0.0001,time);
    g.gain.exponentialRampToValueAtTime(amp,time+0.008);
    g.gain.exponentialRampToValueAtTime(0.0001,time+dur);
    o.connect(f); f.connect(g); g.connect(outGain);
    o.start(time); o.stop(time+dur+0.02);
  }
  function sleighTick(time, outGain, strength=1){
    const len=Math.floor(audioCtx.sampleRate*0.03);
    const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate);
    const data=buf.getChannelData(0);
    for(let i=0;i<len;i++) data[i]=(Math.random()*2-1)*(1-i/len);
    const src=audioCtx.createBufferSource(); src.buffer=buf;

    const hp=audioCtx.createBiquadFilter(); hp.type="highpass"; hp.frequency.setValueAtTime(2500,time);
    const bp=audioCtx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.setValueAtTime(5200,time); bp.Q.setValueAtTime(0.9,time);
    const g=audioCtx.createGain();
    g.gain.setValueAtTime(0.0001,time);
    g.gain.exponentialRampToValueAtTime(0.12*strength,time+0.002);
    g.gain.exponentialRampToValueAtTime(0.0001,time+0.03);

    src.connect(hp); hp.connect(bp); bp.connect(g); g.connect(outGain);
    src.start(time); src.stop(time+0.04);
  }

  function winJingle(){
    if(!sfxOn||!audioCtx) return;
    const t=audioCtx.currentTime+0.02;
    [659.25,783.99,987.77,1318.51].forEach((f,i)=>bell(f,t+i*0.012,0.26,sfxGain,0.18));
    for(let i=0;i<10;i++) sleighTick(t+0.03+i*0.03,sfxGain,0.75);
  }
  function santaRiser(){
    if(!sfxOn||!audioCtx) return;
    const t=audioCtx.currentTime+0.02;
    const run=[392.00, 523.25, 659.25, 783.99, 987.77];
    run.forEach((f,i)=>bell(f, t + i*0.11, 0.30, sfxGain, 0.16));
    for(let i=0;i<18;i++) sleighTick(t + 0.10 + i*0.06, sfxGain, 0.55);
  }
  function bonusJingleRush(){
    if(!sfxOn||!audioCtx) return;
    const t=audioCtx.currentTime+0.02;
    const run=[523.25,587.33,659.25,698.46,783.99,880.00,987.77,1046.5,1174.66,1318.51,1567.98];
    run.forEach((f,i)=>bell(f,t+i*0.05,0.18,sfxGain,0.22));
    for(let i=0;i<50;i++) sleighTick(t+i*0.02,sfxGain,1.08);
  }
  function finaleJingle(){
    if(!sfxOn||!audioCtx) return;
    const t=audioCtx.currentTime+0.02;
    const seq=[659.25,783.99,987.77,1174.66,1318.51,1567.98,1318.51,1174.66,987.77];
    seq.forEach((f,i)=>bell(f,t+i*0.12,0.42,sfxGain,0.16));
    for(let i=0;i<24;i++) sleighTick(t+0.08+i*0.07,sfxGain,0.55);
  }
  function loseThunk(){
    if(!sfxOn||!audioCtx) return;
    const t=audioCtx.currentTime+0.02;
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.type="sine";
    o.frequency.setValueAtTime(180,t);
    o.frequency.exponentialRampToValueAtTime(90,t+0.12);
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.16,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+0.16);
    o.connect(g); g.connect(sfxGain);
    o.start(t); o.stop(t+0.18);
  }

  function startMusic(){
    if(!audioCtx||musicTimer) return;
    const bars=[
      [523.25,659.25,783.99,659.25,880.00,659.25,783.99,659.25],
      [698.46,587.33,784.00,587.33,880.00,587.33,784.00,587.33],
      [783.99,659.25,987.77,659.25,1046.5,659.25,987.77,659.25],
      [523.25,659.25,783.99,659.25,880.00,659.25,783.99,659.25],
    ];
    const stepMs=250;
    musicTimer=setInterval(()=>{
      const t=audioCtx.currentTime+0.02;
      const bar=bars[Math.floor(step/8)%bars.length];
      const note=bar[step%8];
      bell(note,t,0.18,musicGain,0.16);
      if((step%2)===1) sleighTick(t,musicGain,0.45);
      step++;
    },stepMs);
    sleighTimer=setInterval(()=>{
      const t=audioCtx.currentTime+0.02;
      for(let i=0;i<4;i++) sleighTick(t+i*0.03,musicGain,0.30);
    },2000);
  }
  function stopMusic(){
    if(musicTimer){clearInterval(musicTimer); musicTimer=null;}
    if(sleighTimer){clearInterval(sleighTimer); sleighTimer=null;}
  }

  // ---------------------------------
  // Confetti (mobile-safe)
  // ---------------------------------
  const confettiCanvas=document.getElementById("confettiCanvas");
  const ctx=confettiCanvas.getContext("2d",{alpha:true});
  let cw=0,ch=0,dpr=1;
  function resizeCanvas(){
    dpr=Math.min(window.devicePixelRatio||1,2);
    cw=Math.floor(window.innerWidth);
    ch=Math.floor(window.innerHeight);
    confettiCanvas.width=Math.floor(cw*dpr);
    confettiCanvas.height=Math.floor(ch*dpr);
    confettiCanvas.style.width=cw+"px";
    confettiCanvas.style.height=ch+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize",resizeCanvas,{passive:true});
  window.addEventListener("orientationchange",()=>setTimeout(resizeCanvas,120),{passive:true});
  resizeCanvas();

  let particles=[], confettiRaf=null, confettiEndAt=0;
  const confettiColors=["#f6d36f","#2bd26b","#d22b2b","#ffffff","#9be7ff","#ff9bd6"];
  function makeParticle(strength=1){
    const angle=Math.random()*Math.PI*2;
    const speed=(6+Math.random()*10)*strength;
    const size=6+Math.random()*9;
    const shape=Math.random()<0.22?"circle":"rect";
    return {
      x:cw*0.5+(Math.random()*50-25),
      y:ch*0.42+(Math.random()*40-20),
      vx:Math.cos(angle)*speed,
      vy:Math.sin(angle)*speed-(7+Math.random()*7)*strength,
      w:size*(shape==="circle"?1:(0.9+Math.random()*1.4)),
      h:size*(shape==="circle"?1:(1.0+Math.random()*2.3)),
      r:size,
      rot:Math.random()*Math.PI,
      vr:(Math.random()*0.32-0.16)*strength,
      color:confettiColors[Math.floor(Math.random()*confettiColors.length)],
      shape,
      life:1
    };
  }
  function startConfetti(durationMs=1200,strength=1){
    particles=[];
    const baseCount=Math.max(110,Math.min(260,Math.floor(cw/5)));
    const count=Math.floor(baseCount*(0.9+0.8*strength));
    for(let i=0;i<count;i++) particles.push(makeParticle(strength));
    confettiEndAt=performance.now()+durationMs;
    if(confettiRaf) cancelAnimationFrame(confettiRaf);
    confettiRaf=requestAnimationFrame(tickConfetti);
  }
  function tickConfetti(now){
    ctx.clearRect(0,0,cw,ch);
    const gravity=0.58, drag=0.985;
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.vx*=drag;
      p.vy=p.vy*drag+gravity;
      p.x+=p.vx; p.y+=p.vy;
      p.rot+=p.vr;
      const timeLeft=Math.max(0,confettiEndAt-now);
      p.life=Math.min(1,timeLeft/520);

      ctx.save();
      ctx.globalAlpha=0.96*p.life;
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle=p.color;
      if(p.shape==="circle"){
        ctx.beginPath(); ctx.arc(0,0,p.r*0.5,0,Math.PI*2); ctx.fill();
      }else{
        ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      }
      ctx.restore();

      if(p.y>ch+70 || p.x<-70 || p.x>cw+70) particles.splice(i,1);
    }
    if(now<confettiEndAt || particles.length>0){
      confettiRaf=requestAnimationFrame(tickConfetti);
    }else{
      ctx.clearRect(0,0,cw,ch);
      confettiRaf=null;
    }
  }

  // ---------------------------------
  // Reels
  // ---------------------------------
  function setReel(i,top,mid,bot){ reels[i].t.textContent=top; reels[i].m.textContent=mid; reels[i].b.textContent=bot; }
  function randomizeReel(i){ setReel(i,pick(symbolsAll),pick(symbolsAll),pick(symbolsAll)); }

  function spinReel(i,durationMs,intervalMs,finalMid){
    return new Promise(resolve=>{
      let elapsed=0;
      const timer=setInterval(()=>{
        elapsed+=intervalMs;
        randomizeReel(i);
        if(elapsed>=durationMs){
          clearInterval(timer);
          setReel(i,pick(symbolsAll),finalMid,pick(symbolsAll));
          resolve();
        }
      },intervalMs);
    });
  }

  function showBonusTakeover(){
    bonusTakeover.style.setProperty("--takeoverDur", BONUS_TEXT_DURATION_MS + "ms");
    bonusTakeover.classList.remove("on");
    void bonusTakeover.offsetWidth;
    bonusTakeover.classList.add("on");
    setTimeout(()=>bonusTakeover.classList.remove("on"), BONUS_TEXT_DURATION_MS);
  }

  function showFinalTakeover(){
    finalTakeover.style.setProperty("--finalDur", FINAL_TAKEOVER_MS + "ms");
    finalTakeover.classList.remove("on");
    void finalTakeover.offsetWidth;
    finalTakeover.classList.add("on");
    setTimeout(()=>finalTakeover.classList.remove("on"), FINAL_TAKEOVER_MS);
  }

  // ---------------------------------
  // Popup
  // ---------------------------------
  function openPopup(html, sub, mode){
    popupMode = mode || "win";
    popupCard.classList.remove("endLoop");

    winText.innerHTML = html;
    smallText.textContent = sub || "";

    if(popupMode === "lose"){
      closeBtn.style.display = "none";
      spinAgainBtn.style.display = "";
      spinAgainBtn.textContent = "SPIN AGAIN";
    } else if(popupMode === "unlock"){
      closeBtn.style.display = "none";
      spinAgainBtn.style.display = "";
      spinAgainBtn.textContent = "PLAY BONUS";
    } else if(popupMode === "end"){
      closeBtn.style.display = "none";
      spinAgainBtn.style.display = "none";
      popupCard.classList.add("endLoop");
    } else {
      closeBtn.style.display = "";
      spinAgainBtn.style.display = "";
      spinAgainBtn.textContent = "SPIN AGAIN";
    }

    overlay.classList.add("on");
  }

  function closePopup(){
    if(popupMode === "end") return;
    overlay.classList.remove("on");
  }

  function setBonusMode(on){
    document.body.classList.toggle("bonusMode", on);
    spinBtn.innerHTML = on ? `<span>BONUS SPIN!</span> üî•` : `<span>SPIN</span> üîî`;
  }

  function enterEndgameForever(){
    spinBtn.disabled = true;
    setBonusMode(false);
    openPopup(`THANK YOU FOR PLAYING<br/><span class="gold">MERRY CHRISTMAS</span>`, "", "end");
  }

  async function runFinalSequenceThenEnd(){
    if(finaleRunning) return;
    finaleRunning = true;

    closePopup();

    showFinalTakeover();
    startConfetti(FINAL_TAKEOVER_MS - 600, 1.6);
    finaleJingle();
    vibrate([60,30,60,30,120]);

    await sleep(FINAL_TAKEOVER_MS);
    await sleep(FINAL_TO_END_GAP_MS);

    state.pendingFinale = false;
    saveState();
    enterEndgameForever();
  }

  // ---------------------------------
  // Decide if this spin should be a Santa trigger
  // ---------------------------------
  function shouldTriggerSantaThisSpin(){
    if(bonusPending) return false;
    if(state.done) return false;

    const won = prizesWonSoFarExcludingThree(); // 0..19

    // Guaranteed milestones
    if(state.santaMilestones.includes(won) && !state.santaFired.includes(won)){
      state.santaFired.push(won);
      saveState();
      return true;
    }

    // Optional extra triggers (cooldown)
    const cooldownOk = (won - state.lastExtraSantaAtWon) >= EXTRA_SANTA_COOLDOWN_WINS;
    if(cooldownOk && Math.random() < EXTRA_SANTA_CHANCE){
      state.lastExtraSantaAtWon = won;
      saveState();
      return true;
    }

    return false;
  }

  // ---------------------------------
  // Main spin
  // ---------------------------------
  async function spin(){
    if(spinning) return;

    if(state.done){
      await resumeAudioIfNeeded();
      if(state.pendingFinale) return runFinalSequenceThenEnd();
      enterEndgameForever();
      return;
    }

    await resumeAudioIfNeeded();
    startMusic();
    setMusic(musicOn);
    setSfx(sfxOn);

    const isBonusSpin = bonusPending;
    const isSantaTriggerSpin = (!isBonusSpin && shouldTriggerSantaThisSpin());

    const profile = isBonusSpin ? BONUS : NORMAL;

    // IMPORTANT RULE:
    // If the triple Santa trigger spin happens, NO PRIZE can be won on that spin.
    const prizeWin = isSantaTriggerSpin
      ? false
      : (isBonusSpin ? (Math.random() < BONUS_WIN_CHANCE) : (Math.random() < BASE_WIN_CHANCE));

    spinning = true;
    spinBtn.disabled = true;

    if(isBonusSpin){
      bonusPending = false;
      setBonusMode(true);
      showBonusTakeover();
      bonusJingleRush();
      startConfetti(900, 1.7);
      vibrate([70,35,70,35,140]);
    } else {
      setBonusMode(false);
      vibrate(25);
    }

    // Final reel middles
    let finals;
    if(isSantaTriggerSpin){
      // ONLY time triple Santa appears on the final line
      finals = [SANTA_SYMBOL, SANTA_SYMBOL, SANTA_SYMBOL];
    } else if(prizeWin){
      // WINS are NEVER Santa
      const sym = pick(symbolsWin);
      finals = [sym, sym, sym];
    } else {
      // Losses are always distinct (so they can never be triple Santa)
      const a = pick(symbolsAll);
      let b = pick(symbolsAll), c = pick(symbolsAll);
      while(b === a) b = pick(symbolsAll);
      while(c === a || c === b) c = pick(symbolsAll);
      finals = [a,b,c];
    }

    await Promise.all([
      spinReel(0, profile.d1, profile.intervalMs, finals[0]),
      spinReel(1, profile.d2, profile.intervalMs, finals[1]),
      spinReel(2, profile.d3, profile.intervalMs, finals[2]),
    ]);

    await sleep(WIN_POPUP_DELAY_MS);

    state.spins += 1;
    saveState();

    // Santa trigger => unlock bonus ONLY (no prize)
    if(isSantaTriggerSpin){
      santaRiser();
      startConfetti(1100, 1.25);
      await sleep(SANTA_MOMENTUM_DELAY_MS);

      bonusPending = true;

      openPopup(
        `üéÖ üéÖ üéÖ<br/>SANTA‚ÄôS <span class="gold">SLEIGH BONUS</span>`,
        `BONUS SPIN UNLOCKED`,
        "unlock"
      );

      spinBtn.disabled = false;
      setBonusMode(false);
      spinning = false;
      return;
    }

    // Normal / Bonus outcomes
    if(prizeWin){
      const result = awardPrize();
      if(result.type === "prize"){
        startConfetti(profile.confettiMs, profile.confettiStrength);
        winJingle();
        vibrate([40,20,40,20,40]);

        openPopup(
          `YOU WON<br/><span class="gold">PRIZE NUMBER ${result.number}</span>`,
          "Show this number to claim your prize üéÅ",
          "win"
        );

        spinBtn.disabled = false;

        // If that was the final prize (#3), run special sequence after they close / tap
        if(result.number === 3 && state.pendingFinale){
          // nothing here ‚Äî handled on close/spinAgain/overlay click
        }
      } else {
        if(state.pendingFinale) return runFinalSequenceThenEnd();
        enterEndgameForever();
        return;
      }
    } else {
      loseThunk();
      vibrate([20,40,20]);
      openPopup(`SO CLOSE!<br/><span class="gold">TRY AGAIN!</span>`, "Give it another spin üéÖ", "lose");
      spinBtn.disabled = false;
    }

    setBonusMode(false);
    spinning = false;
  }

  // Buttons
  spinBtn.addEventListener("click", spin);

  closeBtn.addEventListener("click", ()=>{
    if(state.done && state.pendingFinale) return runFinalSequenceThenEnd();
    closePopup();
    if(state.done) enterEndgameForever();
  });

  spinAgainBtn.addEventListener("click", ()=>{
    if(state.done && state.pendingFinale) return runFinalSequenceThenEnd();
    closePopup();
    spin(); // if bonusPending, next spin is the bonus
  });

  overlay.addEventListener("click",(e)=>{
    if(e.target === overlay){
      if(state.done && state.pendingFinale) return runFinalSequenceThenEnd();
      closePopup();
      if(state.done) enterEndgameForever();
    }
  });

  // Background snow init
  const snow=document.getElementById("snow");
  (function makeSnow(){
    const count=52;
    for(let i=0;i<count;i++){
      const f=document.createElement("div");
      f.className="flake";
      const size=3+Math.random()*7;
      f.style.width=size+"px";
      f.style.height=size+"px";
      f.style.left=(Math.random()*100)+"vw";
      f.style.opacity=(0.30+Math.random()*0.70).toFixed(2);
      const dur=6+Math.random()*10;
      f.style.animationDuration=dur+"s";
      f.style.animationDelay=(-Math.random()*dur)+"s";
      f.style.setProperty("--drift",((Math.random()*2-1)*70)+"px");
      snow.appendChild(f);
    }
  })();

  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden) stopMusic();
    else if(audioCtx && audioCtx.state==="running") startMusic();
  });

})();
</script>
</body>
</html>
