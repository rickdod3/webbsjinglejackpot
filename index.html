<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#061b14" />

  <!-- iOS ‚Äúapp-like‚Äù mode (works best when you Add to Home Screen) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Jingle Jackpot" />

  <title>Webb‚Äôs Jingle Jackpot</title>

  <style>
    :root{
      --bg1:#061b14;
      --bg2:#0a2b20;
      --gold:#f6d36f;
      --text:#f3fbf7;
      --muted:rgba(243,251,247,.78);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 15%, rgba(246,211,111,.10), transparent 55%),
        radial-gradient(1200px 800px at 85% 30%, rgba(210,43,43,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Snow */
    .snow{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;}
    .flake{
      position:absolute; top:-10vh;
      border-radius:50%;
      background:rgba(255,255,255,.9);
      opacity:.85;
      animation: fall linear infinite;
      filter: blur(.2px);
    }
    @keyframes fall{
      to { transform: translateY(120vh) translateX(var(--drift)); opacity:.2; }
    }

    .wrap{
      position:relative; z-index:1;
      min-height:100svh;
      display:flex; align-items:center; justify-content:center;
      padding:
        calc(18px + env(safe-area-inset-top))
        calc(14px + env(safe-area-inset-right))
        calc(24px + env(safe-area-inset-bottom))
        calc(14px + env(safe-area-inset-left));
    }

    .machine{
      width:min(980px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:26px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      padding:22px;
    }

    .top{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      text-align:center;
    }
    h1{margin:0; font-size: clamp(22px, 3.0vw, 38px); letter-spacing:.2px;}
    .sub{ margin:0; color:var(--muted); font-size:14px; line-height:1.35; }

    .lights{
      display:flex; gap:10px; align-items:center; justify-content:center;
      width:100%; padding-top:2px;
    }
    .bulb{
      width:14px; height:14px; border-radius:50%;
      border:1px solid rgba(255,255,255,.15);
      animation: blink 1.1s infinite;
    }
    .bulb:nth-child(3n+1){ background: rgba(210,43,43,.85); animation-delay:.0s;}
    .bulb:nth-child(3n+2){ background: rgba(246,211,111,.95); animation-delay:.15s;}
    .bulb:nth-child(3n+3){ background: rgba(43,210,107,.85); animation-delay:.3s;}
    @keyframes blink{
      0%,100%{ transform: translateY(0); filter:saturate(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
      50%{ transform: translateY(-1px); filter:saturate(1.2); box-shadow: 0 0 22px rgba(246,211,111,.38); }
    }

    .panel{
      margin-top:18px;
      background: linear-gradient(180deg, rgba(15,58,43,.85), rgba(12,47,35,.85));
      border:1px solid rgba(255,255,255,.10);
      border-radius:24px;
      padding:18px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }

    .reelsRow{
      display:flex;
      gap:14px;
      justify-content:center;
      flex-wrap:wrap;
      align-items:stretch;
    }

    .reel{
      width: clamp(120px, 26vw, 180px);
      height: clamp(168px, 26vh, 198px);
      border-radius:22px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25), 0 10px 25px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      flex: 1 1 auto;
      max-width: 220px;
    }
    .reel::before, .reel::after{
      content:"";
      position:absolute; left:0; right:0;
      height:44px; z-index:2; pointer-events:none;
    }
    .reel::before{top:0; background: linear-gradient(180deg, rgba(6,27,20,.90), rgba(6,27,20,0));}
    .reel::after{bottom:0; background: linear-gradient(0deg, rgba(6,27,20,.90), rgba(6,27,20,0));}

    .payline{
      position:absolute; left:10px; right:10px; top:50%;
      transform: translateY(-50%);
      height:52px;
      border-radius:16px;
      border:2px solid rgba(246,211,111,.65);
      box-shadow: 0 0 24px rgba(246,211,111,.18);
      z-index:3;
      pointer-events:none;
    }

    .reelGrid{
      position:absolute;
      inset: 14px 0 14px 0;
      display:grid;
      grid-template-rows: repeat(3, 1fr);
      gap: 10px;
      padding: 0 12px;
      z-index:1;
    }

    .cell{
      height:52px;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:44px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      user-select:none;
    }
    .cell.mid{
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18), 0 0 20px rgba(246,211,111,.10);
    }

    .controls{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .btn{
      border:0;
      border-radius:16px;
      padding:16px 22px;
      font-weight:1000;
      letter-spacing:.3px;
      cursor:pointer;
      color:#1a1200;
      background: linear-gradient(180deg, rgba(246,211,111,1), rgba(231,179,70,1));
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .15s ease;
      min-width: 240px;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn:disabled{ cursor:not-allowed; opacity:.65; filter: grayscale(.15); }

    .toggles{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center; opacity:.92;
    }
    .tinyBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(243,251,247,.92);
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      font-size:11px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .tinyBtn:hover{ filter: brightness(1.07); }
    .tinyBtn[aria-pressed="true"]{ box-shadow: 0 0 0 2px rgba(246,211,111,.14); }

    .note{
      width:100%;
      text-align:center;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:14px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      max-width: 720px;
    }

    .toast{
      height:0;
      overflow:visible;
      display:flex;
      justify-content:center;
      width:100%;
      pointer-events:none;
    }
    .toast > div{
      margin-top:6px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:8px 12px;
      font-weight:900;
      letter-spacing:.2px;
      font-size:12px;
      color: rgba(243,251,247,.92);
      opacity:0;
      transform: translateY(-6px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show > div{ opacity:1; transform: translateY(0); }

    /* POPUP */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:
        calc(18px + env(safe-area-inset-top))
        calc(18px + env(safe-area-inset-right))
        calc(18px + env(safe-area-inset-bottom))
        calc(18px + env(safe-area-inset-left));
    }
    .overlay.on{ display:flex; }

    .popup{
      width:min(820px, 100%);
      border-radius:28px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(15,58,43,.95), rgba(10,43,32,.95));
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      padding:26px 22px;
      text-align:center;
      position:relative;
      transform: scale(.88);
      opacity:0;
      animation: popIn 520ms ease-out forwards;
      overflow:hidden;
    }
    @keyframes popIn{
      0%{ transform: scale(.86); opacity:0; }
      60%{ transform: scale(1.02); opacity:1; }
      100%{ transform: scale(1); opacity:1; }
    }
    .burst{
      position:absolute; inset:-70px -70px auto -70px;
      height:280px;
      background:
        radial-gradient(closest-side, rgba(246,211,111,.28), transparent 70%),
        radial-gradient(closest-side, rgba(43,210,107,.20), transparent 70%),
        radial-gradient(closest-side, rgba(210,43,43,.20), transparent 70%);
      filter: blur(2px);
      pointer-events:none;
    }
    .winText{
      font-weight:1000;
      letter-spacing:.6px;
      line-height:1.05;
      font-size: clamp(30px, 5.0vw, 66px);
      margin: 12px 0 8px;
      text-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    .winText .gold{
      color: var(--gold);
      text-shadow: 0 10px 34px rgba(246,211,111,.28);
    }
    .smallText{
      margin: 10px 0 0;
      color: rgba(243,251,247,.78);
      font-size: 14px;
    }
    .closeRow{
      margin-top:18px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .closeBtn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:900;
      min-width:180px;
    }
    .closeBtn:hover{ filter: brightness(1.05); }

    /* Confetti */
    .sparkleLayer{
      position:fixed; inset:0; pointer-events:none;
      z-index:60; display:none;
    }
    .sparkleLayer.on{ display:block; }

    .spark{
      position:absolute;
      width:10px; height:10px;
      border-radius:3px;
      opacity:.98;
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.25));
      animation: confetti 1400ms cubic-bezier(.14,.85,.2,1) forwards;
    }
    .spark.circle{ border-radius:50%; width:11px; height:11px; }
    .spark.ribbon{ width:6px; height:16px; border-radius:3px; }
    @keyframes confetti{
      0%   { transform: translate(0,0) rotate(0deg) scale(.9); opacity:0; }
      12%  { opacity:1; }
      100% { transform: translate(var(--dx), var(--dy)) rotate(var(--rot)) scale(.85); opacity:0; }
    }

    .whoosh{
      position:fixed;
      left:50%; top:48%;
      transform: translate(-50%,-50%);
      width:min(900px, 96vw);
      height: min(520px, 60vh);
      pointer-events:none;
      z-index:59;
      opacity:0;
    }
    .whoosh.on{ animation: whoosh 800ms ease-out forwards; }
    @keyframes whoosh{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.92); }
      25%{ opacity:.9; }
      100%{ opacity:0; transform: translate(-50%,-50%) scale(1.04); }
    }

    /* Mobile tune-ups */
    @media (max-width: 520px){
      .machine{ padding:14px; border-radius:22px; }
      .panel{ padding:14px; border-radius:20px; }
      .reelsRow{ gap:10px; }
      .reel{ width:auto; flex: 1 1 30%; max-width: 150px; height: 172px; border-radius:18px; }
      .reelGrid{ inset: 12px 0 12px 0; gap:8px; padding: 0 10px; }
      .cell{ height:46px; font-size:38px; border-radius:14px; }
      .payline{ height:46px; border-radius:14px; }
      .btn{ width:100%; min-width: unset; }
      .closeBtn{ width:100%; min-width: unset; }
    }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>

  <div class="wrap">
    <div class="machine" id="gameRoot" role="application" aria-label="Webb‚Äôs Jingle Jackpot slot machine">
      <div class="top">
        <div>
          <h1>üéÑ Webb‚Äôs Jingle Jackpot üé∞</h1>
          <div class="sub">Spin for your chance to win a prize!</div>
        </div>

        <div class="lights" aria-hidden="true">
          <span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span>
          <span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span>
          <span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span>
        </div>
      </div>

      <div class="panel">
        <div class="reelsRow">
          <div class="reel" aria-label="Reel 1">
            <div class="payline" aria-hidden="true"></div>
            <div class="reelGrid">
              <div class="cell" id="r1t">üéÑ</div>
              <div class="cell mid" id="r1m">üéÅ</div>
              <div class="cell" id="r1b">‚ùÑÔ∏è</div>
            </div>
          </div>

          <div class="reel" aria-label="Reel 2">
            <div class="payline" aria-hidden="true"></div>
            <div class="reelGrid">
              <div class="cell" id="r2t">üîî</div>
              <div class="cell mid" id="r2m">‚≠ê</div>
              <div class="cell" id="r2b">‚õÑ</div>
            </div>
          </div>

          <div class="reel" aria-label="Reel 3">
            <div class="payline" aria-hidden="true"></div>
            <div class="reelGrid">
              <div class="cell" id="r3t">ü¶å</div>
              <div class="cell mid" id="r3m">üéÖ</div>
              <div class="cell" id="r3b">üç™</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="btn" id="spinBtn">
            <span>SPIN</span><span aria-hidden="true">üîî</span>
          </button>

          <div class="toggles">
            <button class="tinyBtn" id="musicBtn" aria-pressed="true">üéµ Music</button>
            <button class="tinyBtn" id="sfxBtn" aria-pressed="true">üîä SFX</button>
            <button class="tinyBtn" id="fsBtn" aria-pressed="false">‚õ∂ Fullscreen</button>
          </div>

          <div class="toast" id="toast"><div id="toastMsg">Try again!</div></div>

          <div class="note" aria-live="polite">
            <span style="font-size:18px">‚ú®</span>
            <span>Watch the middle row ‚Äî that‚Äôs the winning line!</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUP -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Popup">
    <div class="popup">
      <div class="burst" aria-hidden="true"></div>
      <div class="winText" id="winText">
        YOU WON<br/>
        <span class="gold">PRIZE NUMBER 1</span>
      </div>
      <div class="smallText" id="smallText">Show this number to claim your prize üéÅ</div>
      <div class="closeRow">
        <button class="closeBtn" id="closeBtn">CLOSE</button>
        <button class="closeBtn" id="spinAgainBtn">SPIN AGAIN</button>
      </div>
    </div>
  </div>

  <!-- Dramatic glow -->
  <svg class="whoosh" id="whoosh" viewBox="0 0 900 520" aria-hidden="true">
    <defs>
      <radialGradient id="g1" cx="50%" cy="45%" r="60%">
        <stop offset="0%" stop-color="rgba(246,211,111,.35)"/>
        <stop offset="60%" stop-color="rgba(43,210,107,.18)"/>
        <stop offset="100%" stop-color="rgba(210,43,43,.00)"/>
      </radialGradient>
    </defs>
    <circle cx="450" cy="250" r="210" fill="url(#g1)"/>
    <circle cx="320" cy="210" r="130" fill="rgba(255,255,255,.06)"/>
    <circle cx="585" cy="235" r="145" fill="rgba(246,211,111,.08)"/>
  </svg>

  <div class="sparkleLayer" id="sparkleLayer"></div>

<script>
(() => {
  const symbols = ["üéÑ","üéÅ","‚ùÑÔ∏è","üîî","‚≠ê","üß¶","‚õÑ","ü¶å","üç™","üéÖ"];
  const WIN_CHANCE = 0.85;

  const reels = [
    { t: document.getElementById("r1t"), m: document.getElementById("r1m"), b: document.getElementById("r1b") },
    { t: document.getElementById("r2t"), m: document.getElementById("r2m"), b: document.getElementById("r2b") },
    { t: document.getElementById("r3t"), m: document.getElementById("r3m"), b: document.getElementById("r3b") },
  ];

  const gameRoot = document.getElementById("gameRoot");
  const spinBtn = document.getElementById("spinBtn");
  const overlay = document.getElementById("overlay");
  const winText = document.getElementById("winText");
  const smallText = document.getElementById("smallText");
  const closeBtn = document.getElementById("closeBtn");
  const spinAgainBtn = document.getElementById("spinAgainBtn");
  const sparkleLayer = document.getElementById("sparkleLayer");
  const whoosh = document.getElementById("whoosh");

  const musicBtn = document.getElementById("musicBtn");
  const sfxBtn = document.getElementById("sfxBtn");
  const fsBtn = document.getElementById("fsBtn");

  const toast = document.getElementById("toast");
  const toastMsg = document.getElementById("toastMsg");

  let spinning = false;
  let musicOn = true;
  let sfxOn = true;

  const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  // -----------------------
  // Fullscreen button (works on many devices; iPhone Safari often blocks it)
  // -----------------------
  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement);
  }
  async function toggleFullscreen(){
    try{
      if (isFullscreen()){
        if (document.exitFullscreen) await document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      } else {
        const el = document.documentElement;
        if (el.requestFullscreen) await el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      }
    }catch(e){}
    fsBtn.setAttribute("aria-pressed", String(isFullscreen()));
  }
  fsBtn.addEventListener("click", toggleFullscreen);
  document.addEventListener("fullscreenchange", () => fsBtn.setAttribute("aria-pressed", String(isFullscreen())));
  document.addEventListener("webkitfullscreenchange", () => fsBtn.setAttribute("aria-pressed", String(isFullscreen())));

  // -----------------------
  // Prize tracking (1‚Äì20, #3 always last) ‚Äî persisted in localStorage
  // -----------------------
  const STORE_KEY = "webb_jingle_jackpot_v2";
  function freshState(){
    const remaining = [];
    for (let i=1;i<=20;i++) if (i !== 3) remaining.push(i);
    return { remaining, threeWon: false, done: false };
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return freshState();
      const s = JSON.parse(raw);
      if (!s || !Array.isArray(s.remaining)) return freshState();
      return {
        remaining: s.remaining.filter(n => Number.isInteger(n) && n>=1 && n<=20 && n!==3),
        threeWon: !!s.threeWon,
        done: !!s.done
      };
    }catch(e){ return freshState(); }
  }
  function saveState(){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch(e){}
  }
  let state = loadState();

  function awardPrize(){
    if (state.done) return { type:"done" };
    if (state.remaining.length > 0){
      const idx = Math.floor(Math.random() * state.remaining.length);
      const prize = state.remaining[idx];
      state.remaining.splice(idx, 1);
      saveState();
      return { type:"prize", number: prize, last: false };
    }
    if (!state.threeWon){
      state.threeWon = true;
      state.done = true;
      saveState();
      return { type:"prize", number: 3, last: true };
    }
    state.done = true;
    saveState();
    return { type:"done" };
  }

  // -----------------------
  // Audio (Web Audio) ‚Äî starts on first user interaction
  // -----------------------
  let audioCtx = null, master = null, musicGain = null, sfxGain = null;
  let musicTimer = null, sleighTimer = null, step = 0;

  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    master = audioCtx.createGain();
    master.gain.value = 0.9;
    master.connect(audioCtx.destination);

    musicGain = audioCtx.createGain();
    musicGain.gain.value = 0.10;
    musicGain.connect(master);

    sfxGain = audioCtx.createGain();
    sfxGain.gain.value = 0.35;
    sfxGain.connect(master);
  }
  async function resumeAudioIfNeeded(){
    ensureAudio();
    if (audioCtx.state !== "running") {
      try { await audioCtx.resume(); } catch(e) {}
    }
  }

  function setMusic(on){
    musicOn = on;
    musicBtn.setAttribute("aria-pressed", String(on));
    if (!audioCtx) return;
    musicGain.gain.setTargetAtTime(on ? 0.10 : 0.0001, audioCtx.currentTime, 0.03);
  }
  function setSfx(on){
    sfxOn = on;
    sfxBtn.setAttribute("aria-pressed", String(on));
    if (!audioCtx) return;
    sfxGain.gain.setTargetAtTime(on ? 0.35 : 0.0001, audioCtx.currentTime, 0.02);
  }
  musicBtn.addEventListener("click", async () => { await resumeAudioIfNeeded(); setMusic(!musicOn); });
  sfxBtn.addEventListener("click", async () => { await resumeAudioIfNeeded(); setSfx(!sfxOn); });

  function bell(freq, time, dur, outGain){
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const f = audioCtx.createBiquadFilter();
    o.type = "triangle";
    o.frequency.setValueAtTime(freq, time);
    f.type = "bandpass";
    f.frequency.setValueAtTime(1400, time);
    f.Q.setValueAtTime(1.2, time);
    g.gain.setValueAtTime(0.0001, time);
    g.gain.exponentialRampToValueAtTime(0.22, time + 0.008);
    g.gain.exponentialRampToValueAtTime(0.0001, time + dur);
    o.connect(f); f.connect(g); g.connect(outGain);
    o.start(time);
    o.stop(time + dur + 0.02);
  }
  function sleighBellTick(time, outGain, strength=1){
    const len = Math.floor(audioCtx.sampleRate * 0.03);
    const buf = audioCtx.createBuffer(1, len, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<len;i++) data[i] = (Math.random()*2-1) * (1 - i/len);

    const src = audioCtx.createBufferSource();
    src.buffer = buf;

    const hp = audioCtx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.setValueAtTime(2500, time);

    const bp = audioCtx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.setValueAtTime(5200, time);
    bp.Q.setValueAtTime(0.9, time);

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.0001, time);
    g.gain.exponentialRampToValueAtTime(0.12 * strength, time + 0.002);
    g.gain.exponentialRampToValueAtTime(0.0001, time + 0.03);

    src.connect(hp); hp.connect(bp); bp.connect(g); g.connect(outGain);
    src.start(time);
    src.stop(time + 0.04);
  }

  function startMusic(){
    if (!audioCtx || musicTimer) return;
    const bars = [
      [523.25, 659.25, 783.99, 659.25, 880.00, 659.25, 783.99, 659.25],
      [698.46, 587.33, 784.00, 587.33, 880.00, 587.33, 784.00, 587.33],
      [783.99, 659.25, 987.77, 659.25, 1046.5, 659.25, 987.77, 659.25],
      [523.25, 659.25, 783.99, 659.25, 880.00, 659.25, 783.99, 659.25],
    ];
    const stepMs = 250;
    musicTimer = setInterval(() => {
      const t = audioCtx.currentTime + 0.02;
      const bar = bars[Math.floor(step / 8) % bars.length];
      const note = bar[step % 8];
      bell(note, t, 0.20, musicGain);
      if ((step % 2) === 1) sleighBellTick(t, musicGain, 0.55);
      step++;
    }, stepMs);

    sleighTimer = setInterval(() => {
      const t = audioCtx.currentTime + 0.02;
      for (let i=0;i<4;i++) sleighBellTick(t + i*0.03, musicGain, 0.35);
    }, 2000);
  }
  function stopMusic(){
    if (musicTimer){ clearInterval(musicTimer); musicTimer = null; }
    if (sleighTimer){ clearInterval(sleighTimer); sleighTimer = null; }
  }

  function spinWhoosh(){
    if (!sfxOn || !audioCtx) return;
    const t = audioCtx.currentTime;
    for (let i=0;i<8;i++) sleighBellTick(t + i*0.02, sfxGain, 0.85);

    const noiseLen = audioCtx.sampleRate * 0.20;
    const buf = audioCtx.createBuffer(1, noiseLen, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1);

    const src = audioCtx.createBufferSource();
    src.buffer = buf;

    const bp = audioCtx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.setValueAtTime(700, t);
    bp.frequency.exponentialRampToValueAtTime(1600, t + 0.14);
    bp.Q.setValueAtTime(0.8, t);

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.22, t + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.20);

    src.connect(bp); bp.connect(g); g.connect(sfxGain);
    src.start(t);
    src.stop(t + 0.22);
  }
  function reelStopChime(pitch){
    if (!sfxOn || !audioCtx) return;
    const t = audioCtx.currentTime;
    bell(pitch, t, 0.16, sfxGain);
    sleighBellTick(t + 0.01, sfxGain, 0.7);
  }
  function winFanfare(){
    if (!sfxOn || !audioCtx) return;
    const t = audioCtx.currentTime;
    const run = [659.25, 783.99, 987.77, 1046.5, 987.77, 1174.66];
    run.forEach((f, i) => bell(f, t + i*0.08, 0.22, sfxGain));
    for (let i=0;i<14;i++) sleighBellTick(t + 0.12 + i*0.03, sfxGain, 0.65);
  }
  function loseThunk(){
    if (!sfxOn || !audioCtx) return;
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(180, t);
    o.frequency.exponentialRampToValueAtTime(90, t + 0.12);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.18, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.16);
    o.connect(g); g.connect(sfxGain);
    o.start(t); o.stop(t + 0.18);
  }

  // -----------------------
  // Reels
  // -----------------------
  function setReel(i, top, mid, bot){
    reels[i].t.textContent = top;
    reels[i].m.textContent = mid;
    reels[i].b.textContent = bot;
  }
  function randomizeReel(i){
    setReel(i, pick(symbols), pick(symbols), pick(symbols));
  }
  function spinReel(i, durationMs, finalMidSymbol, onStop){
    return new Promise(resolve => {
      const interval = 60;
      let elapsed = 0;
      const timer = setInterval(() => {
        elapsed += interval;
        randomizeReel(i);
        if (elapsed >= durationMs){
          clearInterval(timer);
          setReel(i, pick(symbols), finalMidSymbol, pick(symbols));
          onStop && onStop();
          resolve();
        }
      }, interval);
    });
  }

  // -----------------------
  // Effects / UI
  // -----------------------
  function dramaticConfetti(){
    sparkleLayer.innerHTML = "";
    sparkleLayer.classList.add("on");

    whoosh.classList.remove("on");
    void whoosh.offsetWidth;
    whoosh.classList.add("on");

    const colors = ["#f6d36f","#2bd26b","#d22b2b","#ffffff","#9be7ff","#ff9bd6"];
    const shapes = ["square","circle","ribbon"];
    const count = 160;

    const originX = 50, originY = 45;
    for (let i = 0; i < count; i++){
      const s = document.createElement("div");
      s.className = "spark";
      const shape = shapes[Math.floor(Math.random()*shapes.length)];
      if (shape !== "square") s.classList.add(shape);
      s.style.background = colors[Math.floor(Math.random()*colors.length)];

      const x = originX + (Math.random()*18 - 9);
      const y = originY + (Math.random()*16 - 8);
      s.style.left = x + "vw";
      s.style.top  = y + "vh";

      const angle = Math.random() * Math.PI * 2;
      const dist  = 240 + Math.random()*520;
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist + (170 + Math.random()*320);
      const rot = (Math.random()*900 - 450) + "deg";

      s.style.setProperty("--dx", dx + "px");
      s.style.setProperty("--dy", dy + "px");
      s.style.setProperty("--rot", rot);
      s.style.animationDelay = (Math.random()*170) + "ms";
      sparkleLayer.appendChild(s);
    }
    setTimeout(() => sparkleLayer.classList.remove("on"), 1750);
  }

  function openPopupBig(linesHtml, sub){
    winText.innerHTML = linesHtml;
    smallText.textContent = sub || "";
    overlay.classList.add("on");
  }
  function closePopup(){ overlay.classList.remove("on"); }

  function showToast(msg){
    toastMsg.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 900);
  }

  function allDoneMessage(){
    openPopupBig(
      `THANK YOU FOR PLAYING<br/><span class="gold">MERRY CHRISTMAS</span>`,
      "All prizes have been claimed üéÑ"
    );
    spinBtn.disabled = true;
  }

  // -----------------------
  // Spin
  // -----------------------
  async function spin(){
    if (spinning) return;

    if (state.done){
      allDoneMessage();
      return;
    }

    await resumeAudioIfNeeded();
    startMusic();
    setMusic(musicOn);
    setSfx(sfxOn);

    spinning = true;
    spinBtn.disabled = true;

    spinWhoosh();

    const isWin = Math.random() < WIN_CHANCE;

    let finals;
    if (isWin){
      const sym = pick(symbols);
      finals = [sym, sym, sym];
    } else {
      const a = pick(symbols);
      let b = pick(symbols), c = pick(symbols);
      while (b === a) b = pick(symbols);
      while (c === a || c === b) c = pick(symbols);
      finals = [a, b, c];
    }

    await Promise.all([
      spinReel(0, 900,  finals[0], () => reelStopChime(880.00)),
      spinReel(1, 1200, finals[1], () => reelStopChime(987.77)),
      spinReel(2, 1500, finals[2], () => reelStopChime(1046.5)),
    ]);

    await sleep(550);

    if (isWin){
      const result = awardPrize();
      dramaticConfetti();
      winFanfare();

      if (result.type === "prize"){
        openPopupBig(
          `YOU WON<br/><span class="gold">PRIZE NUMBER ${result.number}</span>`,
          "Show this number to claim your prize üéÅ"
        );
        // If last prize just got assigned (#3), the next spin should show the thank-you message.
        // (Also lock immediately so no extra prizes can be generated.)
        if (result.last) {
          state.done = true;
          saveState();
          spinBtn.disabled = true;
        } else {
          spinBtn.disabled = false;
        }
      } else {
        allDoneMessage();
      }
    } else {
      loseThunk();
      showToast("So close! Spin again üéÖ");
      spinBtn.disabled = false;
    }

    spinning = false;
  }

  spinBtn.addEventListener("click", spin);

  closeBtn.addEventListener("click", closePopup);
  spinAgainBtn.addEventListener("click", () => { closePopup(); spin(); });
  overlay.addEventListener("click", (e) => { if (e.target === overlay) closePopup(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closePopup(); });

  // Snow
  const snow = document.getElementById("snow");
  function makeSnow(){
    const count = 52;
    for (let i=0;i<count;i++){
      const f = document.createElement("div");
      f.className="flake";
      const size = 3 + Math.random()*7;
      f.style.width = size+"px";
      f.style.height = size+"px";
      f.style.left = (Math.random()*100)+"vw";
      f.style.opacity = (0.30 + Math.random()*0.70).toFixed(2);
      const dur = 6 + Math.random()*10;
      f.style.animationDuration = dur+"s";
      f.style.animationDelay = (-Math.random()*dur)+"s";
      f.style.setProperty("--drift", ((Math.random()*2-1)*70) + "px");
      snow.appendChild(f);
    }
  }
  makeSnow();

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) stopMusic();
    else if (audioCtx && audioCtx.state === "running") startMusic();
  });

  if (state.done) spinBtn.disabled = true;
})();
</script>
</body>
</html>
